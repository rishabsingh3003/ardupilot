#pragma once

#include <AP_RangeFinder/AP_RangeFinder_Backend_Serial.h>
#include <AP_LightWareSerial/AP_LightWareSerial.h>

#if AP_RANGEFINDER_LIGHTWARE_GRF_ENABLED

class AP_RangeFinder_LightWareGRF : public AP_RangeFinder_Backend_Serial, AP_LightWareSerial {
public:
    static AP_RangeFinder_Backend_Serial *create(
        RangeFinder::RangeFinder_State &_state,
        AP_RangeFinder_Params &_params)
    {
        return NEW_NOTHROW AP_RangeFinder_LightWareGRF(_state, _params);
    }

    static const struct AP_Param::GroupInfo var_info[];

protected:

    // Returns the MAVLink distance sensor type
    MAV_DISTANCE_SENSOR _get_mav_distance_sensor_type() const override { return MAV_DISTANCE_SENSOR_LASER; }

    // Called periodically to fetch a new range reading
    bool get_reading(float &reading_m) override;

    // Returns read timeout in milliseconds
    uint16_t read_timeout_ms() const override { return 500; }

private:
    // Constructor
    AP_RangeFinder_LightWareGRF(RangeFinder::RangeFinder_State &_state,
                          AP_RangeFinder_Params &_params);

    // Supported command/message IDs by the GRF LightWare rangefinders. We don't use all of them yet. 
    enum class MessageID : uint8_t {
        PRODUCT_NAME           = 0,
        HARDWARE_VERSION       = 1,
        FIRMWARE_VERSION       = 2,
        SERIAL_NUMBER          = 3,
        SAVE_PARAMETERS        = 12,
        RESET                  = 14,
        DISTANCE_OUTPUT        = 27,
        STREAM                 = 30,
        DISTANCE_DATA_CM       = 44,
        DISTANCE_DATA_MM       = 45,
        LASER_FIRING           = 50,
        TEMPERATURE            = 55,
        AUTO_EXPOSURE          = 70,
        UPDATE_RATE            = 74,
        ALARM_STATUS           = 76,
        RETURN_MODE            = 77,
        LOST_SIGNAL_COUNTER    = 78,
        MEDIAN_FILTER_ENABLE   = 86,
        MEDIAN_FILTER_SIZE     = 87,
        SMOOTHING_FILTER_ENABLE= 88,
        SMOOTHING_FACTOR       = 89,
        BAUD_RATE              = 91,
        I2C_ADDRESS            = 92,
        ROLLING_AVERAGE_ENABLE = 93,
        ROLLING_AVERAGE_SIZE   = 94,
        SLEEP_COMMAND          = 98,
        LED_STATE              = 110,
        ZERO_OFFSET            = 114
    };

    // Distance return modes
    enum class GRF_ReturnSelection : uint8_t {
        FIRST_RAW       = 0,
        FIRST_FILTERED  = 1,
        LAST_RAW        = 2,
        LAST_FILTERED   = 3
    };

    // Initialization configuration steps
    enum class ConfigStep : uint8_t {
        HANDSHAKE,
        UPDATE_RATE,
        DISTANCE_OUTPUT,
        STREAM,
        DONE
    };

    // Internal state struct
    struct {
        uint32_t last_init_ms;
        ConfigStep config_step;
    } grf;

    AP_Int8 return_selection;
    AP_Int8 minimum_return_strength;
    AP_Int8 update_rate;


    // Configure the rangefinder
    void configure_rangefinder();

    // Parses config responses and advances setup step
    void check_config();

    // Attempts to parse a single streaming measurement
    bool try_parse_stream_packet(float &reading_m);

    // Checks if PRODUCT_NAME payload matches expected GRF signature
    bool matches_product_name(const uint8_t *buf, uint16_t len);


    // Reads UART and tries to parse a complete response
    bool read_and_parse_response(MessageID& cmd_id_out,
                                 uint8_t* payload_out,
                                 uint16_t& payload_len_out);
};

#endif // AP_RANGEFINDER_LIGHTWARE_GRF_ENABLED
